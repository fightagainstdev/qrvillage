let Q=Math.PI;function Y(e){return Math.abs(e)}function d(e,t){return Math.min(e,t)}function z(e,t){return Math.max(e,t)}function Z(e){return Math.sign(e)}function X(e,t=0,i=1){return e<t?t:i<e?i:e}function F(e,t,i){return i-t?X((e-t)/(i-t)):0}function J(e=1,t=0){return t+Math.random()*(e-t)}function B(e,t=0){return Math.floor(J(e,t))}function c(e=0,t){return"number"==typeof e?new i(e,null==t?e:t):new i(e.x,e.y)}class i{constructor(e=0,t=0){this.x=e,this.y=t}copy(){return new i(this.x,this.y)}add(e){return new i(this.x+e.x,this.y+e.y)}subtract(e){return new i(this.x-e.x,this.y-e.y)}multiply(e){return new i(this.x*e.x,this.y*e.y)}divide(e){return new i(this.x/e.x,this.y/e.y)}scale(e){return new i(this.x*e,this.y*e)}length(){return this.lengthSquared()**.5}lengthSquared(){return this.x**2+this.y**2}distance(e){return this.distanceSquared(e)**.5}distanceSquared(e){return(this.x-e.x)**2+(this.y-e.y)**2}normalize(e=1){var t=this.length();return t?this.scale(e/t):new i(0,e)}clampLength(e=1){var t=this.length();return e<t?this.scale(e/t):this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}angle(){return Math.atan2(this.x,this.y)}setAngle(e=0,t=1){return this.x=t*Math.sin(e),this.y=t*Math.cos(e),this}rotate(e){var t=Math.cos(e),e=Math.sin(e);return new i(this.x*t-this.y*e,this.x*e+this.y*t)}direction(){return Y(this.x)>Y(this.y)?this.x<0?3:1:this.y<0?2:0}invert(){return new i(this.y,-this.x)}floor(){return new i(Math.floor(this.x),Math.floor(this.y))}area(){return Y(this.x*this.y)}lerp(e,t){return this.add(e.subtract(this).scale(X(t)))}arrayCheck(e){return 0<=this.x&&0<=this.y&&this.x<e.x&&this.y<e.y}}class p{constructor(e=1,t=1,i=1,s=1){this.r=e,this.g=t,this.b=i,this.a=s}copy(){return new p(this.r,this.g,this.b,this.a)}scale(e,t=e){return new p(this.r*e,this.g*e,this.b*e,this.a*t)}clamp(){return new p(X(this.r),X(this.g),X(this.b),X(this.a))}rgbaInt(){return(255*X(this.r)|0)+(255*X(this.g)<<8)+(255*X(this.b)<<16)+(255*X(this.a)<<24)}}class s{constructor(e){this.time=null==e?void 0:E+e,this.setTime=e}set(e=0){this.time=E+e,this.setTime=e}unset(){this.time=void 0}isSet(){return null!=this.time}active(){return E<=this.time}elapsed(){return E>this.time}get(){return this.isSet()?E-this.time:0}getPercent(){return this.isSet()?F(this.time-E,this.setTime,0):0}valueOf(){return this.get()}}let h=c(),m=32,L=c(1920,1200),W=c(),R=!0;let q=!0,U=c(12),_=!0,$=.5;class o{constructor(e=c(),t=c(1),i,s=0,n,r=0){this.pos=e.copy(),this.size=t,this.drawSize=void 0,this.tileInfo=i,this.angle=s,this.color=n,this.additiveColor=void 0,this.mirror=!1,this.renderOrder=r,k.push(this)}update(){}render(){r(this.pos,this.drawSize||this.size,this.tileInfo,this.color,this.angle,this.mirror,this.additiveColor)}destroy(){this.destroyed||(this.destroyed=1)}getMirrorSign(){return this.mirror?-1:1}}let l,u,n,N,f=c(),G=[];function a(e=c(),t=U,i=0){var s;return"number"==typeof t&&(t=c(t)),"number"==typeof e&&(e=c(e%(s=G[i].size.x/t.x|0)*t.x,(e/s|0)*t.y)),new j(e,t,i)}class j{constructor(e=c(),t=U,i=0){this.pos=e,this.size=t,this.textureIndex=i}offset(e){return new j(this.pos.add(e),this.size,this.textureIndex)}frame(e){return this.offset(c(e*this.size.x,0))}getTextureInfo(){return G[this.textureIndex]}}class K{constructor(e){this.image=e,this.size=c(e.width,e.height),this.glTexture=(e=>{var t=b.createTexture();return b.bindTexture(A,t),e&&b.texImage2D(A,0,Fe,Fe,Ce,e),e=R?Be:Le,b.texParameteri(A,Re,e),b.texParameteri(A,We,e),t})(e),this.fixBleedSize=c(.1).divide(this.size)}}function g(e){return new i((e.x-f.x/2+.5)/m+h.x,(e.y-f.y/2+.5)/-m+h.y)}function V(e){return new i((e.x-h.x)*m+f.x/2-.5,(e.y-h.y)*-m+f.y/2-.5)}function r(e,t=c(1),i,s=new p,n=0,r,o=new p(0,0,0,0),a){var h,d,l,u=i&&i.getTextureInfo();a&&(e=g(e),t=t.scale(1/m)),u?(a=i.pos.x/u.size.x,h=i.pos.y/u.size.y,d=i.size.x/u.size.x,i=i.size.y/u.size.y,l=u.fixBleedSize,(u=u.glTexture)!=ge&&(Ie(),b.bindTexture(A,ge=u)),Pe(e.x,e.y,r?-t.x:t.x,t.y,n,a+l.x,h+l.y,a-l.x+d,h-l.y+i,s.rgbaInt(),o.rgbaInt())):Pe(e.x,e.y,t.x,t.y,n,0,0,0,0,0,s.rgbaInt())}function v(e,t,i,s,n){r(e,t,void 0,i,s,!1,void 0,n)}function ee(){w=[[]]}let te=function(e,t=0){return w[t]&&!!(1&w[t][e])},t=function(e,t=0){return w[t]&&!!(2&w[t][e])},ie=function(e,t=0){return w[t]&&!!(4&w[t][e])},x=c(),se=c();let w=[[]];function ne(){ae||document.hasFocus()||ee(),x=g(se)}function re(){for(var e of w)for(var t in e)e[t]&=1}function oe(e){var t;return l?(t=l.getBoundingClientRect(),c(l.width,l.height).multiply(c(F(e.x,t.left,t.right),F(e.y,t.top,t.bottom)))):c()}onmousedown=e=>{w[0][e.button]=3,se=oe(e),e.button&&e.preventDefault()},onmouseup=e=>w[0][e.button]=2&w[0][e.button]|4,onmousemove=e=>se=oe(e),oncontextmenu=e=>!1;let ae=void 0!==window.ontouchstart;if(ae){let s;onmousedown=onmouseup=()=>0,ontouchstart=ontouchmove=ontouchend=e=>{_&&y&&"running"!=y.state&&T(0);var t,i=e.touches.length;return i?(t=c(e.touches[0].clientX,e.touches[0].clientY),se=oe(t),s||(w[0][0]=3)):s&&(w[0][0]=2&w[0][0]|4),s=i,document.hasFocus()&&e.preventDefault(),!0}}class he extends class{constructor(e,t=40,i=.7){_&&(this.range=t,this.taper=i,this.randomness=0,e)&&(this.randomness=e[1]||0,e[1]=0,this.sampleChannels=[ce(...e)],this.sampleRate=ue)}play(t,i=1,s=1,n=1,r=!1){if(_&&this.sampleChannels){let e;if(t){var o=this.range;if(o){var a=h.distanceSquared(t);if(o*o<a)return;i*=F(a**.5,o,o*this.taper)}e=2*V(t).x/l.width-1}a=s+s*this.randomness*n*J(-1,1);return this.source=le(this.sampleChannels,i,a,e,r,this.sampleRate)}}stop(){this.source&&this.source.stop(),this.source=void 0}getSource(){return this.source}playNote(e,t,i){return this.play(t,i,2**(e/12),0)}getDuration(){return this.sampleChannels&&this.sampleChannels[0].length/this.sampleRate}isLoading(){return!this.sampleChannels}}{constructor(e){super(void 0),_&&(this.randomness=0,this.sampleChannels=((i,s,n,e=125)=>{let r,o,a,h,d,l,u,c,p,m,f,g,v,x=0,w,y=[],T=[],M=[],b=0,S=0,I=1,A={},P=ue/e*60>>2;for(;I;b++)y=[I=c=g=0],n.forEach((e,t)=>{for(u=s[e][b]||[0,0,0],I|=s[e][b]&&1,w=g+(s[e][0].length-2-(c?0:1))*P,v=t==n.length-1,r=2,a=g;r<u.length+v;c=++r){for(d=u[r],p=r==u.length+v-1&&v||m!=(u[0]||0)||0|d,o=0;o<P&&c;o++>P-99&&p&&f<1&&(f+=1/99))l=(1-f)*y[x++]/2||0,T[a]=(T[a]||0)-l*S+l,M[a]=(M[a++]||0)+l*S+l;d&&(f=d%1,S=u[1]||0,d|=0)&&(y=A[[m=u[x=0]||0,d]]=A[[m,d]]||((h=[...i[m]])[2]*=2**((d-12)/12),0<d?ce(...h):[]))}g=w});return[T,M]})(...e),this.sampleRate=ue)}playMusic(e,t=!1){return super.play(void 0,e,1,1,t)}}let y=new AudioContext,de=!1;function le(t,s=1,n=1,r=0,o=!1,a=ue){if(_){var h=de;if(!(de="running"!=y.state)||(y.resume(),!h)){let i=y.createBuffer(t.length,t[0].length,a),e=y.createBufferSource();t.forEach((e,t)=>i.getChannelData(t).set(e)),e.buffer=i,e.playbackRate.value=n,e.loop=o;h=y.createGain();return h.gain.value=$*s,h.connect(y.destination),e.connect(new StereoPannerNode(y,{pan:X(r,-1,1)})).connect(h),e.start(),e}}}function T(...e){le([ce(...e)])}let ue=44100;function ce(e=1,t=.05,i=220,s=0,n=0,r=.1,o=0,B=1,a=0,h=0,d=0,l=0,u=0,L=0,c=0,W=0,p=0,m=1,f=0,g=0,v=0){let x=2*Q,w=ue,R=a*=500*x/w/w,y=i*=J(1+t,1-t)*x/w,T=[],M=0,q=0,b=0,S=1,U=0,_=0,I=0,A,P,k=x*Y(v)*2/w,E=Math.cos(k),O=Math.sin(k)/2/2,D=1+O,N=-2*E/D,G=(1-O)/D,H=(1+Z(v)*E)/2/D,j=-(Z(v)+E)/D,K=H,C=0,z=0,F=0,V=0;for(s=s*w+9,f*=w,n*=w,r*=w,p*=w,h*=500*x/w**3,c*=x/w,d*=x/w,l*=w,u=u*w|0,e*=$,P=s+f+n+r+p|0;b<P;T[b++]=I*e)++_%(100*W|0)||(I=o?1<o?2<o?3<o?Math.sin(M**3):X(Math.tan(M),1,-1):1-(2*M/x%2+2)%2:1-4*Y(Math.round(M/x)-M/x):Math.sin(M),I=(u?1-g+g*Math.sin(x*b/u):1)*Z(I)*Y(I)**B*(b<s?b/s:b<s+f?1-(b-s)/f*(1-m):b<s+f+n?m:b<P-p?(P-b-p)/r*m:0),I=p?I/2+(p>b?0:(b<P-p?1:(P-b)/p)*T[b-p|0]/2/e):I,v&&(I=V=K*C+j*(C=z)+H*(z=I)-G*F-N*(F=V))),A=(i+=a+=h)*Math.cos(c*q++),M+=A+A*L*Math.sin(b**5),S&&++S>l&&(i+=d,y+=d,S=0),!u||++U%u||(i=y,a=R,S=S||1);return T}class pe{constructor(e,t=0,i=!1,s=new p){this.tile=e,this.direction=t,this.mirror=i,this.color=s}clear(){this.tile=this.direction=0,this.mirror=!1,this.color=new p}}class me extends o{constructor(e,t=c(),i=a(),s=c(1),n=0){super(e,t,i,0,void 0,n),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.scale=s,this.isOverlay=!1,this.data=[];for(let e=this.size.area();e--;)this.data.push(new pe)}setData(e,t,i=!1){e.arrayCheck(this.size)&&(this.data[(0|e.y)*this.size.x+e.x|0]=t,i)&&this.drawTileData(e)}getData(e){return e.arrayCheck(this.size)&&this.data[(0|e.y)*this.size.x+e.x|0]}update(){}render(){q||this.isOverlay||Ae(u);var e=V(this.pos.add(c(0,this.size.y*this.scale.y)));(this.isOverlay?N:u).drawImage(this.canvas,e.x,e.y,m*this.size.x*this.scale.x,m*this.size.y*this.scale.y)}redraw(){this.redrawStart(!0);for(let t=this.size.x;t--;)for(let e=this.size.y;e--;)this.drawTileData(c(t,e),!1);this.redrawEnd()}redrawStart(e=!1){this.savedRenderSettings=[l,u,f,h,m],l=this.canvas,u=this.context,f=this.size.multiply(this.tileInfo.size),h=this.size.scale(.5),m=this.tileInfo.size.x,e&&(l.width=f.x,l.height=f.y),this.context.imageSmoothingEnabled=!R,be()}redrawEnd(){Ae(u,!0),[l,u,f,h,m]=this.savedRenderSettings}drawTileData(e,t=!0){var i=this.tileInfo.size,t=(t&&(t=e.multiply(i),this.context.clearRect(t.x,this.canvas.height-t.y,i.x,-i.y)),this.getData(e));null!=t.tile&&(e=this.pos.add(e).add(c(.5)),i=a(t.tile,i,this.tileInfo.textureIndex),r(e,c(1),i,t.color,t.direction*Q/2,t.mirror))}drawCanvas2D(e,t,i,s,n){var r=this.context;r.save(),e=e.subtract(this.pos).multiply(this.tileInfo.size),t=t.multiply(this.tileInfo.size),r.translate(e.x,this.canvas.height-e.y),r.rotate(i),r.scale(s?-t.x:t.x,t.y),n(r),r.restore()}drawTile(e,t=c(1),i,s=new p,n,r){this.drawCanvas2D(e,t,n,r,e=>{var t=i&&i.getTextureInfo();t?(e.globalAlpha=s.a,e.drawImage(t.image,i.pos.x,i.pos.y,i.size.x,i.size.y,-.5,-.5,1,1),e.globalAlpha=1):(e.fillStyle=s,e.fillRect(-.5,-.5,1,1))})}drawRect(e,t,i,s){this.drawTile(e,t,void 0,i,s)}}let M,b,fe,ge,ve,xe,S,we,I,ye,Te;function Me(){M=document.createElement("canvas"),b=M.getContext("webgl2"),q&&document.body.appendChild(M),fe=(t="#version 300 es\nprecision highp float;uniform mat4 m;in vec2 g;in vec4 p,u,c,a;in float r;out vec2 v;out vec4 d,e;void main(){vec2 s=(g-.5)*p.zw;gl_Position=m*vec4(p.xy+s*cos(r)-vec2(-s.y,s)*sin(r),1,1);v=mix(u.xw,u.zy,g);d=c;e=a;}",i="#version 300 es\nprecision highp float;in vec2 v;in vec4 d,e;uniform sampler2D s;out vec4 c;void main(){c=texture(s,v)*d+e;}",e=b.createProgram(),b.attachShader(e,Se(t,je)),b.attachShader(e,Se(i,Ge)),b.linkProgram(e),e);var e,t=new ArrayBuffer(Xe),i=(S=new Float32Array(t),we=new Uint32Array(t),ve=b.createBuffer(),xe=b.createBuffer(),new Float32Array([I=0,0,1,0,0,1,1,1]));b.bindBuffer(P,xe),b.bufferData(P,i,_e)}function be(){b.viewport(0,0,M.width=l.width,M.height=l.height),b.clear(qe),b.useProgram(fe),b.activeTexture(Ue),b.bindTexture(A,ge=G[0].glTexture);let a=ye=Te=0;var e=(e,t,i,s)=>{var e=b.getAttribLocation(fe,e),n=i&&Ye,r=i&&1,o=1==i;b.enableVertexAttribArray(e),b.vertexAttribPointer(e,s,t,o,n,a),b.vertexAttribDivisor(e,r),a+=s*i},e=(b.bindBuffer(P,xe),e("g",ze,0,2),b.bindBuffer(P,ve),b.bufferData(P,Xe,Ne),e("p",ze,4,4),e("u",ze,4,4),e("c",Ce,1,4),e("a",Ce,1,4),e("r",ze,4,1),c(2*m).divide(f)),t=c(-1).subtract(h.multiply(e));b.uniformMatrix4fv(b.getUniformLocation(fe,"m"),!1,new Float32Array([e.x,0,0,0,0,e.y,0,0,1,1,1,1,t.x,t.y,0,0]))}function Se(e,t){t=b.createShader(t);return b.shaderSource(t,e),b.compileShader(t),t}function Ie(){var e;I&&(e=Te?ke:De,b.blendFuncSeparate(Oe,e,ke,e),b.enable(He),b.bufferSubData(P,0,S),b.drawArraysInstanced(Ee,0,4,I),I=0,Te=ye)}function Ae(e,t=!1){(I||t)&&(Ie(),q&&!t||e.drawImage(M,0,0))}function Pe(e,t,i,s,n,r,o,a,h,d,l=0){(I>=Ve||Te!=ye)&&Ie();var u=I*Ke;S[u++]=e,S[u++]=t,S[u++]=i,S[u++]=s,S[u++]=r,S[u++]=o,S[u++]=a,S[u++]=h,we[u++]=d,we[u++]=l,S[+u]=n,I++}let ke=1,Ee=5,Oe=770,De=771,He=3042,A=3553,Ce=5121,ze=5126,Fe=6408,Be=9728,Le=9729,We=10240,Re=10241,qe=16384,Ue=33984,P=34962,_e=35044,Ne=35048,Ge=35632,je=35633,Ke=11,Ve=1e4,Ye=4*Ke,Xe=Ve*Ye,Je=60;Je;let k=[],Qe=0,E=0,Ze=0,$e=!1;let et=0,O=0;function tt(e,r,o){function a(e=0){var t,i=e-et;if(et=e,Ze+=i/1e3,O=d(O+=$e?0:i,50),h(),$e)ne(),re();else{let e=0;for(O<0&&-9<O&&(e=O,O=0);0<=O;O-=1e3/Je){E=Qe++/Je,ne(),r(),n=s=void 0;for(var s of k){n=void 0;var n=s;n.destroyed||n.update()}k=k.filter(e=>!e.destroyed),re()}O+=e}f=c(l.width,l.height),u.imageSmoothingEnabled=!R,be(),k.sort((e,t)=>e.renderOrder-t.renderOrder);for(t of k)t.destroyed||t.render();o(),Ae(u),requestAnimationFrame(a)}function h(){var e,t;W.x?(l.width=W.x,l.height=W.y,e=innerWidth/innerHeight,t=l.width/l.height,(M||l).style.width=l.style.width=n.style.width=e<t?"100%":"",(M||l).style.height=l.style.height=n.style.height=e<t?"":"100%"):(l.width=d(innerWidth,L.x),l.height=d(innerHeight,L.y)),n.width=l.width,n.height=l.height,f=c(l.width,l.height)}document.body.style.cssText="margin:0;overflow:hidden;background:#5b6ee1;touch-action:none;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none",document.body.appendChild(l=document.createElement("canvas")),u=l.getContext("2d"),Me(),document.body.appendChild(n=document.createElement("canvas")),N=n.getContext("2d");(M||l).style.cssText=l.style.cssText=n.style.cssText="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)",h();let t=new Image;t.onerror=t.onload=()=>{G[0]=new K(t),e(),a()},t.src="t.png"}function it(){font="sans-serif",H.mapMan=new pt,H.trainMenu.push(new At(128,96,a(12),a(c(72,72),24),()=>{for(let e=0;e<H.units.length;e++){var t,i=H.units[e];i.selected&&(H.units.splice(H.units.indexOf(i),1),(t=new yt(i.pos)).shelter=i.shelter,H.units.push(t),i.destroy(),H.state=0)}}),new At(256,96,a(14),a(c(0,24),24),()=>{for(let e=0;e<H.units.length;e++){var t,i=H.units[e];i.selected&&(H.units.splice(H.units.indexOf(i),1),(t=new Mt(i.pos)).shelter=i.shelter,H.units.push(t),i.destroy(),H.state=0)}}));var e=d(128,Math.round(128*innerWidth/900));H.buildMenu.push(new bt(e,96,a(50),6,4,0,()=>{H.showMessage("房子是居住空间"),H.state=D.STATES.BUILD_HOUSE}),new bt(2*e,96,a(c(24,96),c(24)),6,4,0,()=>{H.showMessage("农场用于食物"),H.state=D.STATES.BUILD_FARM}),new bt(3*e,96,a(51),2,1,0,()=>{H.showMessage("墙用于保护"),H.state=D.STATES.BUILD_WALL}),new bt(4*e,96,a(c(0,96),c(24)),6,10,0,()=>{H.showMessage("将工人放入\n兵营训练"),H.state=D.STATES.BUILD_BARRACKS})),H.townHallMenu.push(new St(128,96,a(4),()=>{H.food-=5*H.units.length,H.units.push(new ct(D.HOME.add(c(J(-1,1),-1)))),H.speak(.5<J()?"hi":"hello?")})),H.spellMenu.push(new It(innerWidth-e,innerHeight-192,a(90),5,()=>{H.mana-=5,H.food+=10,T(.9,void 0,588,void 0,.03,.14,void 0,3.9,void 0,-1,650,.05,.04,void 0,void 0,void 0,.08,.84,.3),H.showMessage("食物已创建")}),new It(innerWidth-e,innerHeight-(192+e),a(91),8,()=>{H.mana-=8;for(let e=0;e<H.units.length;e++){var t=H.units[e];t.hitPoints<t.maxHitPoints&&(H.vfxMan.addParticles(t.pos,H.vfxMan.heartPlusses),t.hitPoints=d(t.maxHitPoints,t.hitPoints+2))}for(let e=0;e<H.buildings.length;e++){var i=H.buildings[e];i.hitPoints<i.maxHitPoints&&(H.vfxMan.addParticles(i.pos,H.vfxMan.heartPlusses),i.hitPoints=d(i.maxHitPoints,i.hitPoints+2))}T(void 0,void 0,244,void 0,.05,.32,void 0,1.7,-2,void 0,421,.09,.02,void 0,void 0,void 0,void 0,.8,.15),H.showMessage("朋友已治愈")}),new It(innerWidth-e,innerHeight-(192+2*e),a(89),10,()=>{H.mana-=10;for(let e=0;e<H.enemies.length;e++)H.vfxMan.addParticles(H.enemies[e].pos,H.vfxMan.gasPlumes),H.enemies[e].takeDamage(1);T(.7,void 0,530,.01,.14,.13,void 0,.3,-10,void 0,void 0,void 0,void 0,void 0,32,void 0,.03,.3,.1,void 0,346),H.showMessage("敌人已中毒")}),new It(innerWidth-e,innerHeight-(192+3*e),a(88),20,()=>{H.mana-=20;for(let e=0;e<H.enemies.length;e++)H.vfxMan.addParticles(H.enemies[e].pos,H.vfxMan.sparks),H.enemies[e].takeDamage(H.enemies.length<2?4:2);T(2.8,void 0,48,void 0,.23,.73,4,1.9,void 0,-4,void 0,void 0,.21,.2,void 0,.5,.41,.36,.07,.29),H.showMessage("敌人已击杀")})),H.desiredCameraPos=h=D.HOME,m=d(60,60*innerWidth/700),H.warriorIndex=0,H.warriorTimer=new s(150)}function st(){if(H.musicPlaying==H.music&&H.enemies.length?(H.music.source.stop(),H.music2.playMusic(1,!0),H.musicPlaying=H.music2):H.musicPlaying!=H.music2||H.enemies.length||(H.music2.source.stop(),H.music.playMusic(1,!0),H.musicPlaying=H.music),H.state==D.STATES.GAME_LOST)te(0)&&(ee(),setTimeout(location.reload.bind(location),2));else if(H.state!=D.STATES.GAME_WON)if(12<H.warriorIndex&&!H.enemies.length)H.state=D.STATES.GAME_WON,H.origCameraScale=m,H.maxCameraScale=2*m,H.minCameraScale=m/2,H.dScale=-m/100;else{if(5<H.state?te(0)&&(ee(),H.mapMan.getTileAt(x)||(e=Math.round(x.x),t=Math.round(x.y),H.state==D.STATES.BUILD_BARRACKS?H.buildings.push(new mt(c(e,t))):H.state==D.STATES.BUILD_FARM?H.buildings.push(new ft(c(e,t))):H.state==D.STATES.BUILD_WALL?(H.wood-=2,--H.stone,H.buildings.push(new C(c(e,t),1,a(51)))):nt(c(e,t))),H.state=0):H.inputMan.update(),H.vfxMan.update(),H.warriorTimer.isSet()&&H.warriorTimer.elapsed()){var n=D.WARRIORS[H.warriorIndex];H.speak("第"+n.number+" 战士，"+n.name+" 接近",2,1,1);for(let s=0;s<n.enemies.length;s+=2){let e=a(94+8*B(0,4)),t,i=9<H.warriorIndex?4:3;0==s&&(e=a(n.heroTile||6),t=c(n.heroSize||1.2),i+=12==H.warriorIndex?12:Math.floor(H.warriorIndex/2));var r=new Tt(c(n.enemies[s],n.enemies[s+1]),t,e,i);r.destination=D.HOME,H.enemies.push(r)}var e=n.enemies[0],t=n.enemies[1];H.boat.pos=c(20<e?33:e<5?2:18,20<t?33:t<5?2:18),H.warriorIndex<12?H.warriorTimer.set(90):H.warriorTimer.unset(),H.warriorIndex++}rt(H.units),rt(H.enemies),h!=H.desiredCameraPos&&((e=H.desiredCameraPos.subtract(h)).length()<.2&&(H.desiredCameraPos=h),h=h.add(e.clampLength(e.length()/10)))}}function nt(e){e=new C(e,c(1),a(50));return e.popSupport=2,e.smokePos=e.pos.add(c(.3,.5)),H.wood-=6,H.stone-=4,H.buildings.push(e),e}function rt(s){if(1<s.length){var n=Qe%s.length;for(let i=0;i<s.length;i++)if(i!=n){let e=s[n],t=s[i];i<n&&(r=e,e=t,t=r);var r=t.pos.subtract(e.pos);r.length()<.8&&(e.shelter||(e.pos=e.pos.subtract(r.clampLength(.002))),t.shelter||(t.pos=t.pos.add(r.clampLength(.002))))}}}speechSynthesis.onvoiceschanged=function(){H.voices=speechSynthesis.getVoices()};{var ot=function(){tt(it,st,Pt)};let r=new Image;r.onload=function(){let e=document.createElement("canvas"),t=(e.height=r.height,e.getContext("2d"));t.drawImage(r,0,0);var s=t.getImageData(0,144,36,36).data;H.mapGrid=[];for(let i=0;i<36;i++){H.mapGrid[35-i]=[];for(let t=0;t<36;t++){var n=4*(36*i+t);let e=0;0==s[3+n]||91==s[n]&&110==s[1+n]&&225==s[2+n]||34==s[n]&&32==s[1+n]&&52==s[2+n]?e="w":75==s[n]&&105==s[1+n]&&47==s[2+n]?e="t":155==s[n]&&173==s[1+n]&&183==s[2+n]&&(e="s"),H.mapGrid[35-i][t]=e}}var i=t.getImageData(0,180,96,24);(e=document.createElement("canvas")).height=24,e.width=96,(t=e.getContext("2d")).putImageData(i,0,0),H.fontImage=document.createElement("img"),H.fontImage.src=e.toDataURL("image/png"),ot()},r.src="t.png"}let D={HOME:c(15),STATES:{GAME_LOST:1,GAME_WON:2,TOWNHALL_MENU:3,TRAIN_MENU:4,BUILD_MENU:5,BUILD_BARRACKS:6,BUILD_HOUSE:7,BUILD_FARM:8,BUILD_WALL:9},WARRIORS:[{number:"第一",name:"年轻的哈尔塔夫",heroTile:102,from:"东北",enemies:[32,32]},{number:"第二",name:"好斗的希格拉克",from:"东",enemies:[32,18,30,17]},{number:"第三",name:"智慧的哈尔加",heroTile:118,from:"东南",enemies:[32,3,30,4,32,4]},{number:"第四",name:"肥胖的赫尔夫丹",heroTile:110,from:"南",enemies:[18,3,17,4,19,4]},{number:"第五",name:"沉默的埃德索",heroTile:102,from:"西南",enemies:[3,3,4,4,5,4,6,6]},{number:"第六",name:"冷酷的拉格纳",heroTile:94,from:"西",enemies:[3,18,4,19,5,20,6,21]},{number:"第七",name:"弓箭手雷塞尔",from:"西北",enemies:[3,32,4,30,5,31,6,30]},{number:"第八",name:"快乐的赫格尔",from:"北",enemies:[18,32,19,30,18,31,19,31]},{number:"第九",name:"音乐家威斯",from:"东北",enemies:[32,32,30,30,32,30,31,31,32,31]},{number:"第十",name:"谨慎的斯凯尔德",from:"东",enemies:[32,18,30,17,32,17,32,19,30,18]},{number:"第十一",name:"敏捷的罗内斯",from:"东南",enemies:[32,3,30,4,32,4,31,4,31,3]},{number:"第十二",name:"埃本·法德伦",heroTile:108,from:"南",enemies:[18,3,17,4,19,4,18,4,17,5]},{number:"第十三",name:"国王贝奥武夫",heroTile:116,from:"西南",enemies:[3,3,4,4,5,4,4,19,5,20,6,21,17,4,19,4,18,4,17,5]}]},H={trees:[],stones:[],units:[],enemies:[],buildings:[],boat:void 0,trainMenu:[],buildMenu:[],townHallMenu:[],spellMenu:[],state:0,wood:24,stone:16,food:5,mana:5,voiceIndex:47,phrases:{},voices:[],messageTimer:new s,message:"",origCameraScale:0,maxCameraScale:0,minCameraScale:0,dScale:0,desiredCameraPos:h,startSelect:void 0,countWorkers(){let t=0;for(let e=0;e<H.units.length;e++)H.units[e].weapon||t++;return t},getSupportedPop(){let t=0;for(let e=0;e<H.buildings.length;e++){var i=H.buildings[e];t+=i.needsBuilt?0:i.popSupport}return t},speak(e,t,i,s){e=e.toLowerCase();var n=window.speechSynthesis||speechSynthesis,r=H.phrases[e]||new SpeechSynthesisUtterance(e),o=(H.phrases[e]=r,t=(t=t||H.voiceIndex||47)>H.voices.length-1?B(0,H.voices.length):t,n.getVoices());if(o.length){r.voice=o[t];let e=0;for(;"en"!=r.voice.lang.substr(0,2);)r.voice=o[e++];r.pitch=i||1.5,r.volume=.5,r.rate=s||2,n.cancel(),n.speak(r)}},showMessage(e){H.message=e,H.messageTimer=new s(3)},drawHealthBar(e,t,i){if(t<i){var s=e.subtract(c(i/24,0));v(e,c((i+2)/12,.25),new p(0,0,0)),v(e,c(i/12,1/12),new p(.7,.2,.2));for(let e=0;e<t;e++)v(s,c(1/12),new p(.4,.7,.2)),s.x+=1/12}},musicPlaying:!1};var at,e=[[[.3,0,400],[.1,0,220,,.33,,2]],[[[,,3,,,,,,3,,15,,,,,,3,,,,,,,,3,,15,,,,,,,,2,,,,,,2,,14,,,,,,2,,,,,,,,2,,14,,,,,,,,],[1,,25,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,24,,22,,20,,17,,,,,,,,,,,,,,,,,,,,,,,,,,]],[,[1,,17,,,,20,,,,20,,,,20,,,,,,,,,,,,,,,,,,,,17,,,,18,,17,,,,,,18,,,,17,,,,,,18,,17,,,,15,,,,]]],[0,0,1,1],116],ht=e[1][0],dt=e[1][1];dt[0]=ht[0],H.music=new he(e),e[0].reverse(),ht.splice(1),dt.splice(1),e[3]=160,H.music2=new he(e);class lt{constructor(e,t,i,s){this.x=e,this.y=t,this.pos=c(e,t),this.tileInfo=i,this.requiresWood=0,this.requiresStone=0,this.requiresFood=0,this.requiresWorker=0,this.requiresMana=0,this.requiresPop=0,this.clicked=s}isOver(e,t){e=e>this.pos.x-1&&e<this.pos.x+1&&t>this.pos.y-1&&t<this.pos.y+1;return e&&!this.enoughMaterial()?H.showMessage("需要\n"+(this.requiresWood?this.requiresWood+" 木材\n":"")+(this.requiresStone?this.requiresStone+" 石头\n":"")+(this.requiresFood?this.requiresFood+" 食物\n":"")+(this.requiresWorker?this.requiresWorker+" 工人\n":"")+(this.requiresMana?this.requiresMana+" 法力\n":"")+(this.requiresPop?this.requiresPop+" 居住空间":"")):e&&this.clicked(),e}enoughMaterial(){return H.wood>=this.requiresWood&&H.stone>=this.requiresStone&&H.food>=this.requiresFood&&H.mana>=this.requiresMana&&H.countWorkers()>=this.requiresWorker&&H.getSupportedPop()-H.units.length>=(this.requiresPop||-1e3)}draw(){var e=new p(1,1,1,this.enoughMaterial()?1:.5);this.pos=g(c(this.x,innerHeight-this.y)),r(g(c(this.x,innerHeight-this.y)),c(2),a(c(0,72),c(24,24)),e),r(g(c(this.x,innerHeight-this.y)),c(this.tileInfo.size.x/12,this.tileInfo.size.y/12),this.tileInfo,e)}}class C extends o{constructor(e,t,i){super(e,c(1),a(58)),this.renderOrder=-1e4,this.popSupport=0,this.hitPoints=6,this.maxHitPoints=6,this.pos=e,this.builtTileInfo=i,this.builtSize=t,(H.mapGrid[e.y][e.x]=this).needsBuilt=10;for(let e=this.smokePos=0;e<H.units.length;e++){var s=H.units[e];s.selected&&s.takeOrder("build",this)}}build(e){if(this.needsBuilt=z(0,this.needsBuilt-e),this.needsBuilt<=0)return this.tileInfo=this.builtTileInfo,this.size=this.builtSize,this.renderOrder=-this.pos.y,!0}handleClick(t){if(this.needsBuilt){for(let e=0;e<t.length;e++)t[e].takeOrder("build",this);return!0}}takeDamage(e){this.hitPoints-=e,(this.hitPoints<=0||this.needsBuilt)&&this.destroy()}destroy(){var e=H.buildings.indexOf(this);-1!=e&&H.buildings.splice(e,1),H.mapGrid[Math.round(this.pos.y)][Math.round(this.pos.x)]=0,super.destroy()}render(){super.render(),H.drawHealthBar(this.pos.subtract(c(0,1)),this.hitPoints,this.maxHitPoints)}update(){!this.needsBuilt&&this.smokePos&&Math.random()<.05&&H.vfxMan.addParticles(this.smokePos,H.vfxMan.smoke,1)}}class ut extends o{constructor(e,t,i){super(e,t,i),this.destination=e,this.hitPoints=3,this.maxHitPoints=3,this.speed=1/48,this.walkFrame=0,this.walkTile=a(i.pos.add(c(12,0),i.size)),this.intention=void 0,this.intentionTarget=void 0,this.actionTimer=new s,this.actionFrame=0,this.jumpHeight=0,this.weapon=void 0}takeDamage(e){this.hitPoints-=e,H.vfxMan.addParticles(this.pos,H.vfxMan.bloodDrops),this.hitPoints<=0&&this.destroy()}destroy(){var e=this instanceof ct?H.units:H.enemies,t=e.indexOf(this);-1!=t&&e.splice(t,1),super.destroy()}render(){let e=this.pos.add(c(0,this.step?1/12:this.jumpHeight));this.shelter&&(e=this.pos.add(c(0,8/12))),this.step=Math.floor(this.walkFrame/10)%2,r(e,this.size,this.step?this.walkTile:this.tileInfo,void 0,void 0,this.mirror);let t;"chop"==this.intention||"axe"==this.weapon?t=c(24):"mine"==this.intention?t=c(48,24):"build"==this.intention?t=c(72,24):"farm"==this.intention?t=c(48,72):"sword"==this.weapon?t=c(72,48):"spear"==this.weapon?t=c(0,24):"bow"==this.weapon&&(t=c(72)),t&&this.drawTool(t),this.shelter||H.drawHealthBar(this.pos.subtract(c(0,8/12)),this.hitPoints,this.maxHitPoints)}drawTool(e){let t=this.pos.add(c(0,this.step?-.25:-2/12+this.jumpHeight));r(t=this.shelter?this.pos.add(c(0,.5)):t,c(2),a(e,24),void 0,(this.mirror?1:-1)*this.actionFrame/(12*Q),this.mirror)}searchAndDestroy(t,i,e){let s=1/0,n;for(let e=0;e<t.length;e++){var r=t[e],o=this.pos.distance(r.pos);o<i&&o<s&&(n=r,s=o)}n&&e(n)}}class ct extends ut{constructor(e,t,i=a(4)){super(e,t,i),this.selected=!1,this.wood=0,this.stone=0,this.food=0,this.prayTimer=new s}isOver(e,t){e=e>this.pos.x-this.size.x/2&&e<this.pos.x+this.size.x/2&&t>this.pos.y-this.size.y/2&&t<this.pos.y+this.size.y/2;return e&&!this.selected&&(t=J(),H.speak(t<.3?"what":t<.6?"huh?":"ready")),e}takeOrder(e,t){this.shelter=void 0,this.actionTimer.unset(),this.prayTimer.unset(),this.oldTileInfo&&(this.tileInfo=this.oldTileInfo,delete this.oldTileInfo),this.intention=e,this.destination=(t||this).pos,this.actionFrame=0,"move"!=e&&(this.selected=!1,H.state=0),"build"==e&&(this.pos=this.pos.add(c(.1)));t={chop:["k","choppa","yep?"],mine:["k","yep?"],build:["k","hamma?","yep?"],store:["hoard","stow","store"],shelter:["shellta","safety"],move:["goin","yep?","k"],farm:["fooda","grub","k"],pray:["pray","holy"]};e&&t[e]&&H.speak(t[e][B(0,t[e].length)]),"pray"==e&&H.showMessage("PRAY TO ME!"),this.readyFireTimer&&this.readyFireTimer.set(5)}update(){if(this.prayTimer.isSet()&&this.prayTimer.elapsed()&&(this.oldTileInfo?(this.tileInfo=this.oldTileInfo,delete this.oldTileInfo):(this.oldTileInfo=this.tileInfo,this.tileInfo=a(3)),this.prayTimer.set(1)),this.actionTimer.isSet())if(this.actionTimer.elapsed()){if(this.actionTimer.unset(),this.jumpHeight=0,"chop"==this.intention)this.intentionTarget.chop(),T(void 0,.03,405,void 0,void 0,0,3,.1,8,void 0,void 0,void 0,void 0,.1,27,.4,.04,.44,.01),this.wood+=1;else if("pray"==this.intention){var e=(25-H.mana)/25;J()<e&&(T(.5,void 0,600,void 0,void 0,0,void 0,3.9,void 0,-1,650,.05,.04,void 0,void 0,void 0,.08,.84,.18),H.mana++,H.vfxMan.addParticles(this.pos,H.vfxMan.manaBalls))}else if("farm"==this.intention)this.intentionTarget.farm(),this.food+=1;else if("mine"==this.intention)this.intentionTarget.mine(),T(.5,0,1793,void 0,.05,.02,3,.7,void 0,-1,void 0,void 0,void 0,.1,void 0,void 0,void 0,.63,.02,void 0,-1400),this.stone+=1;else if("build"==this.intention){e=this.intentionTarget.build(1);if(T(void 0,.03,405,void 0,void 0,0,3,.1,8,void 0,void 0,void 0,void 0,.1,27,.4,.04,.44,.01),e&&this.intentionTarget instanceof ft)this.takeOrder("farm",this.intentionTarget);else if(e){for(let e=0;e<H.buildings.length;e++){var t=H.buildings[e];if(t.needsBuilt)return void this.takeOrder("build",t)}this.takeOrder()}}3<=this.wood+this.stone+this.food&&(this.prevIntention=this.intention,this.prevDestination=this.destination,this.intention="store",this.destination=D.HOME)}else{e=this.actionTimer.getPercent();.9<e?(this.actionFrame-=10,this.jumpHeight+=.95<e?-1/32:1/32):this.actionFrame++}else if(!this.destination||this.destination.x==this.pos.x&&this.destination.y==this.pos.y)this.walkFrame=0;else{e=this.destination.subtract(this.pos).angle();if(this.destination.distance(this.pos)<this.speed){if(this.pos=this.destination,this.destination=void 0,"chop"==this.intention){let t=1/0,i;for(let e=0;e<H.trees.length;e++){var s=H.trees[e],n=s.pos.subtract(this.pos).length();n<t&&(i=s,t=n)}i&&(this.destination=i.pos)}}else{var i=c().setAngle(e,this.speed),r=this.pos.add(i),o=H.mapMan.getTileAt(r);if(o)if(o instanceof wt&&"chop"==this.intention)this.actionTimer.set(1),this.actionFrame=0,this.walkFrame=0,this.intentionTarget=o;else if(o instanceof xt&&"mine"==this.intention)this.actionTimer.set(1),this.actionFrame=0,this.walkFrame=0,this.intentionTarget=o;else if(o instanceof gt&&"pray"==this.intention)this.actionTimer.set(3),this.prayTimer.set(.8),this.oldTileInfo=this.tileInfo,this.tileInfo=a(3),this.actionFrame=0,this.walkFrame=0,this.intentionTarget=o;else if(o instanceof C&&"build"==this.intention&&o.needsBuilt)this.actionTimer.set(1),this.actionFrame=0,this.walkFrame=0,this.intentionTarget=o;else if(o instanceof ft&&"farm"==this.intention)this.actionTimer.set(1),this.actionFrame=0,this.walkFrame=0,this.intentionTarget=o;else if(o==this.intentionTarget&&"shelter"==this.intention){for(let e=0;e<H.units.length;e++)if(H.units[e].shelter==o)return void this.takeOrder();this.pos=o.pos.copy(),this.shelter=o,this.renderOrder=this.shelter.renderOrder+1}else o instanceof vt&&"store"==this.intention?(H.wood+=this.wood,H.stone+=this.stone,H.food+=this.food,this.wood=0,this.stone=0,this.food=0,this.intention=this.prevIntention,this.destination=this.prevDestination):(this.pos=this.pos.add(c().setAngle(e,this.speed/4)),this.mirror=i.x<0,this.walkFrame++,this.renderOrder=-this.pos.y);else this.pos=r,this.mirror=i.x<0,this.walkFrame++,this.renderOrder=-this.pos.y}}}render(){this.selected&&r(this.pos,c(16/12),a(1)),super.render()}}H.inputMan={update(){if(t(2)&&(H.state=0,H.units.forEach(e=>{e.selected=!1}),H.desiredCameraPos=x.copy(),ee()),t(0)){if(ee(),at=!0,H.musicPlaying&&H.music.source||(H.music.playMusic(.6,!0),H.musicPlaying=H.music),H.miniMap.isOver(x.x,x.y))return;for(let e=0;H.state==D.STATES.TRAIN_MENU&&e<H.trainMenu.length;e++)if(H.trainMenu[e].isOver(x.x,x.y))return;for(let e=0;H.state==D.STATES.BUILD_MENU&&e<H.buildMenu.length;e++)if(H.buildMenu[e].isOver(x.x,x.y))return;for(let e=0;H.state==D.STATES.TOWNHALL_MENU&&e<H.townHallMenu.length;e++)if(H.townHallMenu[e].isOver(x.x,x.y))return;for(let e=0;e<H.spellMenu.length;e++)if(H.spellMenu[e].isOver(x.x,x.y))return;var i=[];let t=!1;for(let e=0;e<H.units.length;e++){var s=H.units[e];s.selected&&i.push(s),t||(t=s.isOver(x.x,x.y))&&!s.selected&&(s.selected=!0,s.weapon?H.state=0:s.shelter&&s.shelter instanceof mt?H.state=D.STATES.TRAIN_MENU:H.state=D.STATES.BUILD_MENU)}if(t)return void i.forEach(e=>{e.selected=!1});var e=z(0,d(35,Math.round(x.x))),n=z(0,d(35,Math.round(x.y))),n=H.mapGrid[n][e];if(n)return void(n.handleClick&&n.handleClick(i));i.length||(H.startSelect=x),i.forEach(e=>{e.takeOrder("move",{pos:x}),e.selected=!0,e.intention=void 0})}H.startSelect&&(ie(0)?(H.units.forEach(e=>{e.selected=e.pos.x>d(H.startSelect.x,x.x)&&e.pos.y>d(H.startSelect.y,x.y)&&e.pos.x<z(H.startSelect.x,x.x)&&e.pos.y<z(H.startSelect.y,x.y)}),delete H.startSelect):(e=x.subtract(H.startSelect),v(x.subtract(e.multiply(c(.5))),e,new p(1,1,1,.2))))}};class pt{constructor(){this.mapWidth=36,this.mapHeight=36;var s=new me(c(-.5),c(36,36));for(let i=0;i<36;i++)for(let t=0;t<36;t++){let e=0;var n=B(0,5),r=H.mapGrid[i][t],r=("w"==r?e=11:"t"==r?H.trees.push(new wt(c(t,i))):"s"==r&&H.stones.push(new xt(c(t,i))),new pe(e,n));s.setData(c(t,i),r)}s.redraw(),H.buildings.push(new vt(D.HOME),new gt(c(17,22))),nt(D.HOME.subtract(c(3,1))).build(10),H.units.push(new ct(c(14,12))),H.boat=new o(c(33),c(3),a(c(48,132),24))}getTileAt(e){return e.x<0||e.y<0?1:H.mapGrid[Math.round(e.y)][Math.round(e.x)]}}class mt extends C{constructor(e){super(e,c(2),a(c(0,96),c(24))),this.hitPoints=10,this.maxHitPoints=10,H.mapGrid[e.y][e.x]=this,H.wood-=6,H.stone-=4}handleClick(t){if(!super.handleClick(t)){for(let e=0;e<t.length;e++)t[e].takeOrder("shelter",this),t[e].intentionTarget=this;return t.length||H.showMessage("PUT A WORKER\nINSIDE TO UPGRADE"),!0}}destroy(){for(let e=0;e<H.units.length;e++){var t=H.units[e];t.shelter==this&&(t.shelter=void 0)}super.destroy()}}class ft extends C{constructor(e){super(e,c(2),a(c(24,96),c(24))),H.wood-=6,H.stone-=4,this.food=50}handleClick(t){if(!super.handleClick(t)){for(let e=0;e<t.length;e++)t[e].takeOrder("farm",this);return!0}}farm(){--this.food,this.food<=0&&this.destroy()}}class gt extends C{constructor(e){super(e,c(2),a(c(48,96),c(24))),this.hitPoints=18,this.maxHitPoints=18,this.build(10)}handleClick(t){if(!super.handleClick(t)){t.length||H.showMessage("神圣神殿");for(let e=0;e<t.length;e++)t[e].takeOrder("pray",this);return!0}}}class vt extends C{constructor(e){super(e,c(2),a(c(72,96),24)),this.popSupport=3,this.hitPoints=18,this.maxHitPoints=18,this.build(10),this.smokePos=e.subtract(c(.3,-.75))}handleClick(t){for(let e=0;e<t.length;e++)t[e].selected=!1;return H.state=D.STATES.TOWNHALL_MENU,!0}destroy(){H.state=D.STATES.GAME_LOST,super.destroy()}}class xt extends o{constructor(e){super(e,c(1),a(8)),this.renderOrder=-e.y,(H.mapGrid[e.y][e.x]=this).stone=48}handleClick(e){e.forEach(e=>{e.weapon||e.takeOrder("mine",this)})}mine(){--this.stone,this.stone<=0&&(H.mapGrid[this.pos.y][this.pos.x]=0,H.stones.splice(H.stones.indexOf(this),1),this.destroy())}}class wt extends o{constructor(e){super(e.add(c(0,.45)),c(1,2),a(c(24,0),c(12,24))),this.renderOrder=-e.y,this.mirror=.5<J(),(H.mapGrid[e.y][e.x]=this).wood=8}handleClick(e){e.forEach(e=>{e.weapon||e.takeOrder("chop",this)})}chop(){--this.wood,this.wood<=0&&(H.mapGrid[Math.round(this.pos.y)][this.pos.x]=0,H.trees.splice(H.trees.indexOf(this),1),this.destroy())}}class yt extends ct{constructor(e){super(e,c(1),a(12)),this.selected=!1,this.weapon="bow",this.readyFireTimer=new s(1),H.wood-=4,H.stone-=2}update(){!this.actionTimer.isSet()&&this.readyFireTimer.elapsed()&&this.searchAndDestroy(H.enemies,this.shelter?4:3,e=>{this.actionTimer.unset(),this.actionFrame=0,this.walkFrame=0,this.intentionTarget=e,this.intention="shoot",T(.7,void 0,334,.13,void 0,.2,4,3,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,.77,.03,void 0,103),this.readyFireTimer.set(4),H.vfxMan.showArrow(this.pos.copy(),e)}),super.update()}}class Tt extends ut{constructor(e,t,i,s){super(e,t,i),this.weapon=.5<J()?"axe":"sword",this.speed=1/64,s&&(this.hitPoints=s,this.maxHitPoints=s)}isOver(e,t){return e>this.pos.x-this.size.x/2&&e<this.pos.x+this.size.x/2&&t>this.pos.y-this.size.y/2&&t<this.pos.y+this.size.y/2}update(){var e,t,i,s;this.actionTimer.isSet()?this.actionTimer.elapsed()?(this.actionTimer.unset(),T(void(this.jumpHeight=0),.03,405,void 0,void 0,0,3,.1,8,void 0,void 0,void 0,void 0,.1,27,.4,.04,.44,.01),this.intentionTarget.takeDamage(Math.floor(Math.sqrt(this.maxHitPoints)))):.9<(e=this.actionTimer.getPercent())?(this.actionFrame-=10,this.jumpHeight+=.95<e?-1/32:1/32):this.actionFrame++:!this.destination||this.destination.x==this.pos.x&&this.destination.y==this.pos.y?this.walkFrame=0:(e=this.destination.subtract(this.pos).angle(),this.destination.distance(this.pos)<this.speed?this.destination=D.HOME:(this.searchAndDestroy(H.units,.8,e=>{e.shelter||(this.actionTimer.set(1),this.actionFrame=0,this.intentionTarget=e)}),this.searchAndDestroy(H.units,3,e=>{this.destination=e.pos}),t=c().setAngle(e,this.speed),i=this.pos.add(t),(s=H.mapMan.getTileAt(i))?s instanceof C?(this.actionTimer.set(1),this.actionFrame=0,this.intentionTarget=s):(this.pos=this.pos.add(c().setAngle(e,this.speed/4)),this.mirror=t.x<0,this.walkFrame++,this.renderOrder=-this.pos.y):(this.pos=i,this.mirror=t.x<0,this.walkFrame++,this.renderOrder=-this.pos.y)))}render(){super.render(),this.drawTool("axe"==this.weapon?c(24):c(72,48))}}class Mt extends ct{constructor(e){super(e,c(1),a(14)),this.weapon="spear",this.hitPoints=6,this.maxHitPoints=6,H.wood-=4,H.stone-=2}update(){this.actionTimer.isSet()?this.actionTimer.elapsed()&&this.intentionTarget instanceof Tt&&(this.actionTimer.unset(),T(void(this.jumpHeight=0),.03,405,void 0,void 0,0,3,.1,8,void 0,void 0,void 0,void 0,.1,27,.4,.04,.44,.01),this.intentionTarget.takeDamage(1)):this.shelter||(this.searchAndDestroy(H.enemies,.8,e=>{this.actionTimer.set(1),this.actionFrame=0,this.intentionTarget=e}),this.searchAndDestroy(H.enemies,3,e=>{this.destination=e.pos})),super.update()}takeDamage(e){super.takeDamage(e/2)}}class bt extends lt{constructor(e,t,i,s,n,r,o){super(e,t,i,o),this.requiresWood=s,this.requiresStone=n}}class St extends lt{constructor(e,t,i,s){super(e,t,i,s),this.requiresPop=1}enoughMaterial(){return this.requiresFood=5*H.units.length,super.enoughMaterial()}}class It extends lt{constructor(e,t,i,s,n){super(e,t,i,n),this.requiresMana=s}}class At extends lt{constructor(e,t,i,s,n){super(e,t,i,n),this.weaponTile=s,this.requiresWood=4,this.requiresStone=2,this.requiresWorker=1}draw(){super.draw();var e=new p(1,1,1,this.enoughMaterial()?1:.5);r(g(c(this.x,innerHeight-this.y)).add(c(0,-2/12)),c(2),this.weaponTile,e)}}function Pt(){if(H.vfxMan.render(),H.state==D.STATES.GAME_LOST)drawText("你输了\n点击重试？",g(c(innerWidth/2,innerHeight/2)),.08,!0);else if(H.state==D.STATES.GAME_WON)((m+=H.dScale)>H.maxCameraScale||m<H.minCameraScale)&&(H.dScale=-H.dScale),drawText("你击败了\n英雄们！",g(c(innerWidth/2,innerHeight/2)),.08,!0);else{if(5<H.state){var s=Math.round(x.x),n=Math.round(x.y);let e=new p(1,1,1,.5),t=c(1),i=a(50);H.mapMan.getTileAt(x)&&(e=new p(1,0,0,.5)),H.state==D.STATES.BUILD_BARRACKS?(t=c(2),i=a(c(0,96),c(24))):H.state==D.STATES.BUILD_WALL?i=a(51):H.state==D.STATES.BUILD_FARM&&(t=c(2),i=a(c(24,96),c(24))),r(c(s,n),t,i,e)}s=d(128,Math.round(128*innerWidth/800));let e=g(c(s,64));if(kt(e,a(36),H.wood),kt(g(c(innerWidth-s,64)),a(45),H.mana),kt(e=e.subtract(c(0,2)),a(44),H.stone),kt(e=e.subtract(c(0,2)),a(37),H.food),kt(e=e.subtract(c(0,2)),a(4),H.units.length+"/"+H.getSupportedPop()),H.state==D.STATES.BUILD_MENU)for(let e=0;e<H.buildMenu.length;e++)H.buildMenu[e].draw();if(H.state==D.STATES.TRAIN_MENU)for(let e=0;e<H.trainMenu.length;e++)H.trainMenu[e].draw();else if(H.state==D.STATES.TOWNHALL_MENU)for(let e=0;e<H.townHallMenu.length;e++)H.townHallMenu[e].draw();for(let e=0;e<H.spellMenu.length;e++)H.spellMenu[e].draw();H.miniMap.draw(s),H.message&&(H.messageTimer.elapsed()&&(H.message=""),drawText(H.message,h.subtract(c(0,5)),.08,!0));n=Math.ceil(-H.warriorTimer.valueOf());let t;H.warriorIndex<12&&n<31?(s=D.WARRIORS[H.warriorIndex],t=s.number+" "+n+"\n"+s.from):H.enemies.length&&(t=D.WARRIORS[H.warriorIndex-1].name+"  \n"+H.warriorIndex+"/13"),t&&drawText(t,g(c(innerWidth/2,24)),.08,!0),at||drawText("温多尔\n村庄",g(c(innerWidth/2,+innerHeight/3)),d(.16,.16*innerWidth/700),!0)}}function kt(e,t,i){r(e,c(4,2),a(c(0,48),c(48,24))),r(e.subtract(c(.85,0)),c(1),t),drawText(i,e.add(c(.5,.2)),.08,!0)}H.miniMap={dx:128,isOver(e,t){var i=g(c(innerWidth-H.miniMap.dx,innerHeight-H.miniMap.dx)),e=e-(i.x-1.5),t=t-(i.y-1.5);if(0<e&&e<=3&&0<t&&t<=3)return H.desiredCameraPos=c(12*e,12*t),!0},draw(e){H.miniMap.dx=e;e=g(c(innerWidth-e,innerHeight-e));r(e,c(3),a(c(0,144),c(36,36))),v(e,c(28/12),new p(.2,.6,.4)),H.miniMap.drawObjects(e,[H.trees,H.stones,H.buildings.concat(H.units),H.enemies],[new p(.3,.4,.2),new p(.61,.68,.72),new p(.6,1,.3),new p(.9,.3,.4)])},drawObjects(t,i,s){for(let e=0;e<i.length;e++){var n=i[e],r=s[e];for(let e=0;e<n.length;e++){var o=n[e];v(t.add(c((o.pos.x-18)/12,(o.pos.y-18)/12)),c((o instanceof vt?2:1)/12),r)}}}},H.vfxMan={arrows:[],bloodDrops:[],gasPlumes:[],sparks:[],heartPlusses:[],manaBalls:[],smoke:[],showArrow(e,t){var i=new o(e,1,a(9),t.pos.subtract(e).angle());H.vfxMan.arrows.push({object:i,origin:e,target:t})},update(){for(let e=0;e<H.vfxMan.arrows.length;e++){var t=H.vfxMan.arrows[e],i=t.target.pos.subtract(t.origin);t.object.pos=t.object.pos.add(i.clampLength(.1)),t.object.pos.subtract(t.target.pos).length()<.1&&(t.target.takeDamage(1),T(void 0,.03,405,void 0,void 0,0,3,.1,8,void 0,void 0,void 0,void 0,.1,27,.4,.04,.44,.01),t.object.destroy(),H.vfxMan.arrows.splice(H.vfxMan.arrows.indexOf(t),1))}},render(){H.vfxMan.updateParticles(H.vfxMan.bloodDrops,function(e){v(e.pos,c(1/12),new p(.7,.2,.2)),e.dy-=.002}),H.vfxMan.updateParticles(H.vfxMan.gasPlumes,function(e){v(e.pos,c(.25),new p(.4,.7,.2,.4)),e.pos.y-=e.dy/2}),H.vfxMan.updateParticles(H.vfxMan.heartPlusses,function(e){v(e.pos,c(.25,1/12),new p(.4,.7,.2)),v(e.pos,c(1/12,.25),new p(.4,.7,.2))}),H.vfxMan.updateParticles(H.vfxMan.sparks,function(e){v(e.pos,c(1/12),new p(1,.9,.2))}),H.vfxMan.updateParticles(H.vfxMan.manaBalls,function(e){v(e.pos,c(2/12),new p(.4,.6,1))}),H.vfxMan.updateParticles(H.vfxMan.smoke,function(e){v(e.pos,c(2/12),new p(.6,.7,.7,1-e.lifetime/40)),e.pos.x-=e.dx/2,e.pos.y-=3*e.dy/4})},updateParticles(t,i){for(let e=0;e<t.length;e++){var s=t[e];s.pos.x+=s.dx,s.pos.y+=s.dy,i(s),s.lifetime++,40<s.lifetime&&(t.splice(e,1),e--)}},addParticles(t,i,e=5){var s=B(1,e);for(let e=0;e<s;e++){var n=J()*Q;i.push({pos:t.copy(),dx:.01*Math.cos(n),dy:.05*Math.sin(n),lifetime:0})}}};